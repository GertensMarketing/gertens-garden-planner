
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gertens Garden Planner</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Html2Canvas for Screen Capture -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">

    <style>
        /* Branding & Custom Styles */
        :root {
            --gertens-blue: #005596;
            --gertens-dark: #003366;
            --blueprint-grid: rgba(255, 255, 255, 0.1);
        }

        html, body, #root {
            height: 100%;
            margin: 0;
            padding: 0;
            width: 100%;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            overflow: hidden; /* Prevent scrolling on app view */
        }

        .font-mono {
            font-family: 'Roboto Mono', monospace;
        }

        /* Blueprint Effect for Landing */
        .blueprint-bg {
            background-color: var(--gertens-blue);
            background-image: 
                linear-gradient(var(--blueprint-grid) 1px, transparent 1px),
                linear-gradient(90deg, var(--blueprint-grid) 1px, transparent 1px);
            background-size: 40px 40px;
            position: relative;
        }

        .blueprint-bg::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(circle, transparent 20%, #002244 150%);
            pointer-events: none;
        }

        /* Map Styles */
        #map {
            height: 100vh;
            width: 100%;
            z-index: 0;
            background: #e5e7eb; /* Fallback color */
            position: absolute;
            top: 0;
            left: 0;
        }
        
        /* Cursor Styles */
        .cursor-crosshair {
            cursor: crosshair !important;
        }
        .cursor-crosshair .leaflet-interactive {
            cursor: crosshair !important;
        }

        /* UI Overlay Z-Index */
        .ui-layer {
            z-index: 1000;
        }

        /* Hide scrollbars for item lists */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Print Styles */
        @media print {
            .no-print {
                display: none !important;
            }
            .print-only {
                display: block !important;
            }
            #map {
                height: 100vh;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                z-index: -1;
            }
        }
        
        /* Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up {
            animation: fadeIn 0.3s ease-out forwards;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- Mock Data ---

        const PLANT_CATEGORIES = [
            { id: 'annual', name: 'Annual Plant', icon: 'ðŸŒ»', color: '#FCD34D' },
            { id: 'perennial', name: 'Perennial Plant', icon: 'ðŸŒ¸', color: '#F472B6' },
            { id: 'shrub', name: 'Shrub', icon: 'ðŸŒ³', color: '#10B981' },
            { id: 'evergreen_shrub', name: 'Evergreen Shrub', icon: 'ðŸŒ²', color: '#065F46' },
            { id: 'evergreen_tree', name: 'Evergreen Tree', icon: 'ðŸŽ„', color: '#064E3B' },
            { id: 'ornamental_tree', name: 'Ornamental Tree', icon: 'ðŸ', color: '#D97706' },
        ];

        const PLANT_DATABASE = {
            'shrub': [
                { name: 'Boxwood Green Mountain', sku: 'S001' },
                { name: 'Hydrangea Endless Summer', sku: 'S002' },
                { name: 'Spirea Goldmound', sku: 'S003' },
                { name: 'Lilac Common Purple', sku: 'S004' },
                { name: 'Dogwood Red Twig', sku: 'S005' }
            ],
            'annual': [
                { name: 'Petunia Wave Purple', sku: 'A001' },
                { name: 'Marigold French', sku: 'A002' },
                { name: 'Begonia Wax', sku: 'A003' }
            ],
            'perennial': [
                { name: 'Hosta Patriot', sku: 'P001' },
                { name: 'Daylily Stella D\'Oro', sku: 'P002' },
                { name: 'Coneflower Purple', sku: 'P003' }
            ],
            'evergreen_shrub': [
                { name: 'Juniper Blue Rug', sku: 'ES001' },
                { name: 'Yew Taunton', sku: 'ES002' }
            ],
            'evergreen_tree': [
                { name: 'Spruce Colorado Blue', sku: 'ET001' },
                { name: 'Pine White', sku: 'ET002' }
            ],
            'ornamental_tree': [
                { name: 'Maple Autumn Blaze', sku: 'OT001' },
                { name: 'Crabapple Spring Snow', sku: 'OT002' }
            ]
        };

        const POT_SIZES = [
            { label: '1 Gallon', circumference: 21 },
            { label: '2 Gallon', circumference: 28 },
            { label: '3 Gallon', circumference: 33 },
            { label: '5 Gallon', circumference: 37 },
            { label: '7 Gallon', circumference: 44 },
            { label: '10 Gallon', circumference: 50 },
        ];

        // --- Helper Functions ---

        const getRadiusInMeters = (circumferenceInches) => {
            const circumferenceMeters = circumferenceInches * 0.0254;
            const radiusMeters = circumferenceMeters / (2 * Math.PI);
            return radiusMeters; 
        };

        // --- Main Application Component ---

        function App() {
            // View State
            const [view, setView] = useState('landing'); // landing, locate, wizard, planning
            const [address, setAddress] = useState('');
            const [coordinates, setCoordinates] = useState(null); 
            const [shoppingList, setShoppingList] = useState([]);
            
            // Map References
            const mapRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const boundaryLayerRef = useRef(null);
            const maskLayerRef = useRef(null);
            const itemsLayerRef = useRef(null);
            const tempDrawingLayerRef = useRef(null);
            const aiLayerRef = useRef(null); 
            const houseLayerRef = useRef(null); // New layer for house mask
            const hardscapeLayerRef = useRef(null); // New layer for hardscape mask

            // Logic State
            const [wizardStep, setWizardStep] = useState(0); // 0=off, 1=Boundary, 2=House, 3=Hardscape, 4=Ready
            const [boundaryPoints, setBoundaryPoints] = useState([]);
            const [housePoints, setHousePoints] = useState([]); // Points for house polygon
            const [hardscapePoints, setHardscapePoints] = useState([]); // Points for hardscape polygon
            const [bedPoints, setBedPoints] = useState([]); 
            
            const [items, setItems] = useState([]); 
            const [selectedItemId, setSelectedItemId] = useState(null);
            
            const [isDrawingBed, setIsDrawingBed] = useState(false);
            const [isPlacingPlant, setIsPlacingPlant] = useState(null); 
            
            // AI / API State
            const [userApiKey, setUserApiKey] = useState("");
            const [showSettings, setShowSettings] = useState(false);
            const [isGenerating, setIsGenerating] = useState(false);
            const [aiImageGenerated, setAiImageGenerated] = useState(false);
            const [showHints, setShowHints] = useState(true); // Default open for first time

            // Refs for Event Listeners to avoid stale closures
            const wizardStepRef = useRef(wizardStep);
            const isDrawingBedRef = useRef(isDrawingBed);
            const isPlacingPlantRef = useRef(isPlacingPlant);

            useEffect(() => { wizardStepRef.current = wizardStep; }, [wizardStep]);
            useEffect(() => { isDrawingBedRef.current = isDrawingBed; }, [isDrawingBed]);
            useEffect(() => { isPlacingPlantRef.current = isPlacingPlant; }, [isPlacingPlant]);
            
            // UI State
            const [showShoppingList, setShowShoppingList] = useState(false);
            const [searchResults, setSearchResults] = useState([]);
            const [isSearching, setIsSearching] = useState(false);

            // Address Search Debounce
            useEffect(() => {
                const timer = setTimeout(() => {
                    if (address.length > 5 && view === 'landing') {
                        setIsSearching(true);
                        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`)
                            .then(res => res.json())
                            .then(data => {
                                setSearchResults(data);
                                setIsSearching(false);
                            })
                            .catch(err => {
                                console.error(err);
                                setIsSearching(false);
                            });
                    }
                }, 500);
                return () => clearTimeout(timer);
            }, [address, view]);

            // --- Map Initialization ---
            useEffect(() => {
                // 1. CLEANUP PHASE
                // If we are back at landing, OR if the map div is gone, destory the old map instance.
                if (view === 'landing' || !mapRef.current) {
                    if (mapInstanceRef.current) {
                        mapInstanceRef.current.remove();
                        mapInstanceRef.current = null;
                    }
                    return;
                }

                // 2. INITIALIZATION PHASE
                // Only create if mapRef exists (div is there) AND mapInstance is null
                if (mapRef.current && !mapInstanceRef.current) {
                    
                    const map = L.map(mapRef.current, {
                        zoomControl: false,
                        attributionControl: false,
                        preferCanvas: true,
                        zoomAnimation: false, 
                        fadeAnimation: true
                    }).setView(coordinates || [44.85, -93.05], 19);

                    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                        attribution: 'Tiles &copy; Esri',
                        maxZoom: 22,
                        maxNativeZoom: 19
                    }).addTo(map);

                    // Initialize all layer groups
                    const aiGroup = L.layerGroup().addTo(map);
                    const maskGroup = L.layerGroup().addTo(map);
                    const houseGroup = L.layerGroup().addTo(map);
                    const hardscapeGroup = L.layerGroup().addTo(map);
                    const boundaryGroup = L.layerGroup().addTo(map);
                    const itemsGroup = L.layerGroup().addTo(map);
                    const tempGroup = L.layerGroup().addTo(map);

                    aiLayerRef.current = aiGroup;
                    boundaryLayerRef.current = boundaryGroup;
                    maskLayerRef.current = maskGroup;
                    houseLayerRef.current = houseGroup;
                    hardscapeLayerRef.current = hardscapeGroup;
                    itemsLayerRef.current = itemsGroup;
                    tempDrawingLayerRef.current = tempGroup;
                    mapInstanceRef.current = map;

                    map.on('click', (e) => handleMapClick(e));

                    // 3. SIZING FIX PHASE
                    // Aggressively invalidate size to fix gray screen issues
                    const resizeObserver = new ResizeObserver(() => {
                        map.invalidateSize();
                    });
                    resizeObserver.observe(mapRef.current);

                    // Fallback polling for the first 500ms to catch animations
                    let attempts = 0;
                    const interval = setInterval(() => {
                        map.invalidateSize();
                        attempts++;
                        if (attempts > 10) clearInterval(interval);
                    }, 50);
                } else if (mapInstanceRef.current && coordinates) {
                    // If map exists, just update view (e.g. if user picked new address without going to landing)
                    mapInstanceRef.current.setView(coordinates, 19);
                }
            }, [view, coordinates]);

            // --- Gemini API Logic ---
            const generateAiIllustration = async () => {
                if (!mapInstanceRef.current) return;
                
                setIsGenerating(true);
                
                try {
                    const mapElement = document.getElementById('map');
                    
                    // Capture map with current overlays (Blue boundary, Grey House, Light Grey Hardscape)
                    const canvas = await html2canvas(mapElement, {
                        useCORS: true,
                        allowTaint: true,
                        ignoreElements: (element) => element.classList.contains('ui-layer') 
                    });
                    
                    const base64Image = canvas.toDataURL('image/png').split(',')[1];
                    const apiKey = userApiKey || ""; 
                    
                    if (!apiKey && typeof __app_id === 'undefined') {
                       alert("Please enter a Gemini API Key in the settings (bottom left) to use this feature.");
                       setIsGenerating(false);
                       setShowSettings(true);
                       return;
                    }

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [
                                    { text: "Turn this map markup into a high-quality, top-down architectural landscape design illustration. The blue line is the property boundary. The dark gray shape is the house structure. The light gray shapes are driveways/walkways. Make the rest look like a professional garden plan with a white paper background, faint grid lines, and watercolor style greenery. Remove blurriness. Keep the exact layout." },
                                    { inlineData: { mimeType: "image/png", data: base64Image } }
                                ]
                            }],
                            generationConfig: {
                                responseModalities: ["IMAGE"]
                            }
                        })
                    });

                    const data = await response.json();
                    
                    if (data.error) throw new Error(data.error.message);

                    const resultBase64 = data.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                    
                    if (resultBase64) {
                        const bounds = mapInstanceRef.current.getBounds();
                        const imageUrl = `data:image/png;base64,${resultBase64}`;
                        
                        aiLayerRef.current.clearLayers();
                        L.imageOverlay(imageUrl, bounds, { opacity: 0.9 }).addTo(aiLayerRef.current);
                        setAiImageGenerated(true);
                        
                        // Switch to White Mask for the "Paper" feel
                        maskLayerRef.current.clearLayers(); 
                         const world = [[90, -180], [90, 180], [-90, 180], [-90, -180]];
                        L.polygon([world, boundaryPoints], {
                            color: 'transparent',
                            fillColor: '#FFFFFF', 
                            fillOpacity: 0.8
                        }).addTo(maskLayerRef.current);
                        
                        // Clean up setup layers so we just see the pretty illustration + items
                        // We keep boundary layer but hide the ugly setup fills
                        houseLayerRef.current.clearLayers();
                        hardscapeLayerRef.current.clearLayers();
                        
                        // Move to planning mode
                        setWizardStep(0); 
                        setView('planning');
                        
                    } else {
                        alert("Could not generate image. Try again.");
                    }

                } catch (error) {
                    console.error("AI Gen Error:", error);
                    alert("Error generating illustration: " + error.message);
                } finally {
                    setIsGenerating(false);
                }
            };

            const toggleAiView = () => {
                if (aiImageGenerated) {
                    // Toggle visibility logic if needed
                    // For now, let's just re-generate if they click it again or implement hide
                } else {
                    generateAiIllustration();
                }
            };

            // --- Handlers ---

            const handleMapClick = (e) => {
                const { lat, lng } = e.latlng;
                const currentStep = wizardStepRef.current;

                // WIZARD STEP 1: Property Boundary
                if (currentStep === 1) {
                    setBoundaryPoints(prev => {
                        const newPoints = [...prev, [lat, lng]];
                        renderTempPolyline(newPoints, 'white');
                        return newPoints;
                    });
                    return;
                }

                // WIZARD STEP 2: House Outline
                if (currentStep === 2) {
                    setHousePoints(prev => {
                        const newPoints = [...prev, [lat, lng]];
                        renderTempPolyline(newPoints, '#4b5563'); // Dark Gray
                        return newPoints;
                    });
                    return;
                }

                // WIZARD STEP 3: Hardscape Outline
                if (currentStep === 3) {
                    setHardscapePoints(prev => {
                        const newPoints = [...prev, [lat, lng]];
                        renderTempPolyline(newPoints, '#9ca3af'); // Light Gray
                        return newPoints;
                    });
                    return;
                }

                // PLANNING: Draw Bed
                if (isDrawingBedRef.current) {
                    setBedPoints(prev => {
                        const newPoints = [...prev, [lat, lng]];
                        renderTempPolyline(newPoints, '#8B4513');
                        return newPoints;
                    });
                    return;
                }

                // PLANNING: Place Plant
                if (isPlacingPlantRef.current) {
                    const newItem = {
                        id: Date.now(),
                        type: 'plant',
                        category: isPlacingPlantRef.current,
                        lat: lat,
                        lng: lng,
                        confirmed: false,
                        name: 'Unspecified Plant',
                        sizeLabel: '1 Gallon', 
                        radius: getRadiusInMeters(21), 
                        sunlight: 'Full Sun'
                    };
                    setItems(prev => [...prev, newItem]);
                    setIsPlacingPlant(null);
                    setSelectedItemId(newItem.id); 
                    renderItems([...items, newItem]);
                }
            };

            const renderTempPolyline = (points, color) => {
                tempDrawingLayerRef.current.clearLayers();
                if (points.length > 0) {
                    L.polygon(points, { color: color, fill: false, dashArray: '5, 5', weight: 2 }).addTo(tempDrawingLayerRef.current);
                    points.forEach(p => {
                        L.circleMarker(p, { radius: 3, color: 'yellow', fillColor: color, fillOpacity: 1 }).addTo(tempDrawingLayerRef.current);
                    });
                }
            };
            
            // --- Undo & Navigation Logic ---
            
            const handleUndo = () => {
                if (wizardStep === 1) {
                    setBoundaryPoints(prev => {
                        const newPoints = prev.slice(0, -1);
                        renderTempPolyline(newPoints, 'white');
                        return newPoints;
                    });
                } else if (wizardStep === 2) {
                    setHousePoints(prev => {
                        const newPoints = prev.slice(0, -1);
                        renderTempPolyline(newPoints, '#4b5563');
                        return newPoints;
                    });
                } else if (wizardStep === 3) {
                    setHardscapePoints(prev => {
                        const newPoints = prev.slice(0, -1);
                        renderTempPolyline(newPoints, '#9ca3af');
                        return newPoints;
                    });
                } else if (isDrawingBed) {
                    setBedPoints(prev => {
                        const newPoints = prev.slice(0, -1);
                        renderTempPolyline(newPoints, '#8B4513');
                        return newPoints;
                    });
                }
            };
            
            const handlePreviousStep = () => {
                if (wizardStep === 2) {
                    // Back to 1: Clear committed boundary, restore points to temp
                    maskLayerRef.current.clearLayers();
                    boundaryLayerRef.current.clearLayers();
                    renderTempPolyline(boundaryPoints, 'white');
                    setWizardStep(1);
                } else if (wizardStep === 3) {
                    // Back to 2: Clear committed house
                    houseLayerRef.current.clearLayers();
                    renderTempPolyline(housePoints, '#4b5563');
                    setWizardStep(2);
                } else if (wizardStep === 4) {
                    // Back to 3: Clear committed hardscape
                    hardscapeLayerRef.current.clearLayers();
                    renderTempPolyline(hardscapePoints, '#9ca3af');
                    setWizardStep(3);
                }
            };

            // --- Wizard Confirm Logic ---

            const confirmWizardStep1 = () => {
                if (boundaryPoints.length < 3) {
                    alert("Please select at least 3 points to create a boundary.");
                    return;
                }
                
                // Commit Boundary
                tempDrawingLayerRef.current.clearLayers();
                
                // Draw Mask (Darken outside)
                const world = [[90, -180], [90, 180], [-90, 180], [-90, -180]];
                L.polygon([world, boundaryPoints], {
                    color: 'transparent',
                    fillColor: '#000000',
                    fillOpacity: 0.75
                }).addTo(maskLayerRef.current);

                // Draw Boundary Line
                L.polygon(boundaryPoints, {
                    color: '#3b82f6', weight: 3, fill: false
                }).addTo(boundaryLayerRef.current);

                // Zoom to property
                const bounds = L.latLngBounds(boundaryPoints);
                mapInstanceRef.current.fitBounds(bounds, { padding: [50, 50], maxZoom: 21 });

                // Move to Step 2
                setWizardStep(2);
            };

            const confirmWizardStep2 = () => {
                // It is possible to have no house points if they skip, but unlikely.
                if (housePoints.length > 0 && housePoints.length < 3) {
                     alert("Please finish the house shape or clear it.");
                     return;
                }

                if (housePoints.length >= 3) {
                    L.polygon(housePoints, {
                        color: 'transparent',
                        fillColor: '#374151', // Dark Gray
                        fillOpacity: 0.8
                    }).addTo(houseLayerRef.current);
                }
                
                tempDrawingLayerRef.current.clearLayers();
                setWizardStep(3);
            };

            const confirmWizardStep3 = () => {
                if (hardscapePoints.length > 0 && hardscapePoints.length < 3) {
                     alert("Please finish the hardscape shape or clear it.");
                     return;
                }

                if (hardscapePoints.length >= 3) {
                    L.polygon(hardscapePoints, {
                        color: 'transparent',
                        fillColor: '#9ca3af', // Light Gray
                        fillOpacity: 0.8
                    }).addTo(hardscapeLayerRef.current);
                }

                tempDrawingLayerRef.current.clearLayers();
                setWizardStep(4); // Ready state
            };


            // --- Planning Logic ---

            const finishBed = () => {
                if (bedPoints.length < 3) {
                    alert("Beds need at least 3 points");
                    return;
                }
                const newBed = {
                    id: Date.now(),
                    type: 'bed',
                    points: bedPoints,
                    sunlight: 'Full Sun',
                    name: 'Garden Bed'
                };
                setItems(prev => [...prev, newBed]);
                setBedPoints([]);
                setIsDrawingBed(false);
                tempDrawingLayerRef.current.clearLayers();
                renderItems([...items, newBed]);
            };

            const updateItem = (id, updates) => {
                const newItems = items.map(item => item.id === id ? { ...item, ...updates } : item);
                setItems(newItems);
                renderItems(newItems);
                if (updates.name) updateShoppingList(newItems);
            };

            const deleteItem = (id) => {
                const newItems = items.filter(item => item.id !== id);
                setItems(newItems);
                setSelectedItemId(null);
                renderItems(newItems);
                updateShoppingList(newItems);
            };

            const updateShoppingList = (currentItems) => {
                const list = currentItems
                    .filter(i => i.type === 'plant' && i.confirmed)
                    .reduce((acc, item) => {
                        const key = `${item.name} (${item.sizeLabel})`;
                        if (!acc[key]) acc[key] = { count: 0, name: item.name, size: item.sizeLabel, category: item.category };
                        acc[key].count++;
                        return acc;
                    }, {});
                setShoppingList(Object.values(list));
            };

            const renderItems = (itemsToRender) => {
                itemsLayerRef.current.clearLayers();
                
                itemsToRender.forEach(item => {
                    if (item.type === 'plant') {
                        const categoryColor = PLANT_CATEGORIES.find(c => c.id === item.category)?.color || '#fff';
                        
                        if (!item.confirmed) {
                            const marker = L.circleMarker([item.lat, item.lng], {
                                radius: 10, color: '#fff', fillColor: '#6b7280', fillOpacity: 1, weight: 2
                            }).addTo(itemsLayerRef.current);
                            marker.on('click', (e) => {
                                if (isPlacingPlantRef.current) return;
                                setSelectedItemId(item.id);
                                L.DomEvent.stopPropagation(e);
                            });
                            marker.bindTooltip("?", { permanent: true, direction: 'center', className: 'font-bold text-white bg-transparent border-0 shadow-none' }).openTooltip();
                        } else {
                            const circle = L.circle([item.lat, item.lng], {
                                radius: item.radius, color: '#1f2937', weight: 1, fillColor: categoryColor, fillOpacity: 0.8
                            }).addTo(itemsLayerRef.current);
                            circle.on('click', (e) => {
                                if (isPlacingPlantRef.current) return;
                                setSelectedItemId(item.id);
                                L.DomEvent.stopPropagation(e);
                            });
                        }
                    } else if (item.type === 'bed') {
                        const polygon = L.polygon(item.points, {
                            color: '#5D4037', weight: 2, fillColor: '#8B4513', fillOpacity: 0.5
                        }).addTo(itemsLayerRef.current);
                        polygon.on('click', (e) => {
                            if (isPlacingPlantRef.current) return;
                            setSelectedItemId(item.id);
                            L.DomEvent.stopPropagation(e);
                        });
                    }
                });
            };

            // --- Render Components ---

            const renderLanding = () => (
                <div className="blueprint-bg w-full h-screen flex flex-col items-center justify-center text-white px-4">
                    <div className="max-w-2xl w-full text-center space-y-8 z-10">
                        <img src="https://gertensmap.netlify.app/images/NEW_Gertens%20Standard%20Logo%20for%20anything-%20white300dpi.png" alt="Gertens Logo" className="h-16 mx-auto mb-4" />
                        <h1 className="text-4xl md:text-6xl font-bold tracking-tight">GARDEN PLANNER</h1>
                        <p className="text-xl text-blue-100 font-mono">Build your dream landscape on a satellite blueprint.</p>
                        <div className="relative max-w-lg mx-auto w-full">
                            <div className="relative">
                                <input 
                                    type="text" 
                                    placeholder="Enter your home address..." 
                                    className="w-full p-4 pr-12 rounded-none border-2 border-white bg-transparent text-white placeholder-blue-200 focus:outline-none focus:bg-blue-900/50 transition font-mono"
                                    value={address}
                                    onChange={(e) => setAddress(e.target.value)}
                                />
                                {isSearching && (
                                    <div className="absolute right-4 top-1/2 transform -translate-y-1/2">
                                        <svg className="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                    </div>
                                )}
                            </div>
                            {searchResults.length > 0 && (
                                <div className="absolute top-full left-0 right-0 bg-white text-black mt-2 rounded shadow-xl max-h-60 overflow-y-auto">
                                    {searchResults.map((result, idx) => (
                                        <div key={idx} className="p-3 hover:bg-gray-100 cursor-pointer border-b text-left" onClick={() => { setCoordinates([parseFloat(result.lat), parseFloat(result.lon)]); setAddress(result.display_name); setSearchResults([]); }}>{result.display_name}</div>
                                    ))}
                                </div>
                            )}
                        </div>
                        {coordinates && (
                            <button onClick={() => { setView('locate'); setTimeout(() => setWizardStep(1), 500); }} className="bg-white text-blue-900 px-8 py-3 font-bold hover:bg-blue-50 transition transform hover:scale-105 shadow-lg tracking-widest">LOCATE MY LANDSCAPE</button>
                        )}
                    </div>
                </div>
            );

            const renderWizardOverlay = () => {
                if (wizardStep === 0) return null;

                const stepContent = {
                    1: {
                        title: "Step 1: Create your boundary",
                        desc: "Please create a border around your property by clicking each corner of your property line.",
                        action: confirmWizardStep1,
                        btnText: "CONFIRM BOUNDARY",
                        color: "bg-blue-600"
                    },
                    2: {
                        title: "Step 2: Create your house's outline",
                        desc: "Outline your house's silhouette using the same method. This helps us distinguish your home from the garden.",
                        action: confirmWizardStep2,
                        btnText: "CONFIRM HOUSE",
                        color: "bg-gray-700"
                    },
                    3: {
                        title: "Step 3: Hardscape",
                        desc: "Outline any pavement, driveways, or walkways. This helps us distinguish hard surfaces.",
                        action: confirmWizardStep3,
                        btnText: "CONFIRM HARDSCAPE",
                        color: "bg-gray-500"
                    },
                    4: {
                        title: "Step 4: Generate Illustration",
                        desc: "We have everything we need! Click below to transform your satellite view into a professional blueprint.",
                        action: generateAiIllustration,
                        btnText: isGenerating ? "GENERATING..." : "CREATE A BASELINE ILLUSTRATION OF MY HOUSE",
                        color: "bg-purple-600"
                    }
                }[wizardStep];

                if (!stepContent) return null;

                return (
                    <div className="absolute bottom-10 left-1/2 transform -translate-x-1/2 ui-layer no-print w-full max-w-2xl px-4">
                        <div className="bg-white rounded-xl shadow-2xl overflow-hidden animate-fade-in-up">
                            <div className={`${stepContent.color} text-white px-6 py-4 flex justify-between items-center`}>
                                <h3 className="font-bold text-lg">{stepContent.title}</h3>
                                <div className="flex items-center space-x-4">
                                    <div className="text-xs opacity-75 font-mono">STEP {wizardStep} OF 4</div>
                                    {wizardStep < 4 && (
                                        <button 
                                            onClick={handleUndo}
                                            title="Undo last point"
                                            className="bg-white/20 hover:bg-white/30 rounded p-1 transition"
                                        >
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 14 4 9l5-5"/><path d="M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5v0a5.5 5.5 0 0 1-5.5 5.5H11"/></svg>
                                        </button>
                                    )}
                                </div>
                            </div>
                            <div className="p-6">
                                <p className="text-gray-600 mb-6 text-sm md:text-base leading-relaxed">{stepContent.desc}</p>
                                
                                <div className="flex space-x-3">
                                    {wizardStep > 1 && (
                                        <button 
                                            onClick={handlePreviousStep}
                                            className="px-4 py-3 bg-gray-100 text-gray-600 font-bold rounded-lg hover:bg-gray-200 transition"
                                        >
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                                        </button>
                                    )}
                                    <button 
                                        onClick={stepContent.action}
                                        disabled={isGenerating}
                                        className={`flex-1 ${stepContent.color} text-white font-bold py-3 rounded-lg hover:opacity-90 transition shadow-md flex justify-center items-center space-x-2`}
                                    >
                                        {isGenerating && <svg className="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>}
                                        <span>{stepContent.btnText}</span>
                                    </button>
                                </div>
                                
                                {wizardStep > 1 && wizardStep < 4 && (
                                    <button onClick={() => { tempDrawingLayerRef.current.clearLayers(); setWizardStep(prev => prev + 1); }} className="w-full mt-2 text-gray-400 text-xs hover:text-gray-600 py-2">
                                        Skip this step
                                    </button>
                                )}

                                {/* Helpful Hints Section for Step 1 */}
                                {wizardStep === 1 && (
                                    <div className="mt-4 border-t pt-2">
                                        <button 
                                            onClick={() => setShowHints(!showHints)} 
                                            className="text-xs text-blue-600 font-bold flex items-center hover:text-blue-800 focus:outline-none"
                                        >
                                            <span className="mr-1">{showHints ? 'â–¼' : 'â–¶'}</span> Helpful Hints
                                        </button>
                                        
                                        {showHints && (
                                            <ul className="text-xs text-gray-500 list-disc ml-4 mt-2 space-y-1">
                                                <li>It is better to go beyond your property line a little bit when creating your boundary. It's good to include some of the road in front of your house.</li>
                                                <li>The boundary can be a custom shape and you can add as many points to the map as needed.</li>
                                                <li>If you make a mistake, use the UNDO button (top right of this box).</li>
                                            </ul>
                                        )}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            };

            const renderMapUI = () => (
                <>
                    {/* Header */}
                    <div className="absolute top-0 left-0 w-full bg-white/90 backdrop-blur-md shadow-md p-4 flex justify-between items-center ui-layer no-print">
                        <div className="flex items-center space-x-2">
                             <img src="https://gertensmap.netlify.app/images/NEW_Gertens%20Standard%20Logo%20for%20anything-%20white300dpi.png" alt="Gertens" className="h-8 invert" />
                             <span className="font-bold text-gray-700 hidden md:block">| PLANNING TOOL</span>
                        </div>
                        <div className="flex space-x-3 items-center">
                             {/* AI Button (Only visible if wizard is done) */}
                             {view === 'planning' && wizardStep === 0 && (
                                <button 
                                    onClick={toggleAiView}
                                    disabled={isGenerating}
                                    className={`flex items-center space-x-2 text-sm font-semibold px-4 py-2 rounded-full transition ${isGenerating ? 'bg-gray-100 text-gray-400' : aiImageGenerated ? 'bg-purple-100 text-purple-700 hover:bg-purple-200' : 'bg-gradient-to-r from-purple-600 to-indigo-600 text-white hover:shadow-lg'}`}
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M7 1v8"/></svg>
                                    <span>{aiImageGenerated ? 'Reset' : 'Regenerate'}</span>
                                </button>
                             )}

                             {view === 'planning' && (
                                 <button onClick={() => window.print()} className="flex items-center space-x-2 text-sm font-semibold text-gray-600 hover:text-blue-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                                    <span className="hidden sm:inline">PRINT PLAN</span>
                                 </button>
                             )}
                        </div>
                    </div>

                    {/* Wizard Overlay */}
                    {renderWizardOverlay()}

                    {/* Planning Action Banner (Bed/Plant) */}
                    <div className="absolute top-20 left-1/2 transform -translate-x-1/2 ui-layer no-print w-full max-w-md px-4">
                        {isDrawingBed && (
                            <div className="bg-amber-700 text-white px-6 py-3 rounded-full shadow-lg flex items-center justify-between">
                                <span className="text-sm">Draw bed shape</span>
                                <div className="flex space-x-2">
                                    <button onClick={handleUndo} className="bg-white/20 p-1 rounded hover:bg-white/30" title="Undo Point">
                                         <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 14 4 9l5-5"/><path d="M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5v0a5.5 5.5 0 0 1-5.5 5.5H11"/></svg>
                                    </button>
                                    <button onClick={() => { setIsDrawingBed(false); setBedPoints([]); tempDrawingLayerRef.current.clearLayers(); }} className="text-xs underline">Cancel</button>
                                    <button onClick={finishBed} className="bg-white text-amber-700 px-3 py-1 rounded-full text-xs font-bold hover:bg-gray-100">FINISH BED</button>
                                </div>
                            </div>
                        )}
                        {isPlacingPlant && (
                             <div className="bg-green-600 text-white px-6 py-3 rounded-full shadow-lg flex items-center justify-between">
                                <span className="text-sm">Place {PLANT_CATEGORIES.find(c => c.id === isPlacingPlant)?.name}</span>
                                <button onClick={() => setIsPlacingPlant(null)} className="text-xs underline">Cancel</button>
                            </div>
                        )}
                    </div>

                    {/* Left Sidebar: Tools */}
                    {view === 'planning' && wizardStep === 0 && !isDrawingBed && (
                        <div className="absolute left-4 top-32 w-16 bg-white rounded-lg shadow-lg flex flex-col items-center py-4 space-y-4 ui-layer no-print">
                            <button onClick={() => setIsDrawingBed(true)} className="w-12 h-12 rounded-full flex flex-col items-center justify-center text-amber-700 hover:bg-amber-50 transition border-2 border-transparent hover:border-amber-200 mb-2" title="Add Garden Bed">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 22v-5l5-5 5 5-5 5z"/><path d="M9.5 14.5 16 8"/><path d="m17 2 5 5-.5.5a3.53 3.53 0 0 1-5 0s0 0 0 0a3.53 3.53 0 0 1 0-5L17 2z"/></svg>
                                <span className="text-[9px] font-bold">BED</span>
                            </button>
                            <hr className="w-10 border-gray-200" />
                            {PLANT_CATEGORIES.map(cat => (
                                <button key={cat.id} onClick={() => setIsPlacingPlant(cat.id)} className={`w-10 h-10 rounded-full flex items-center justify-center text-xl hover:bg-blue-50 transition border-2 ${isPlacingPlant === cat.id ? 'border-blue-600 bg-blue-100' : 'border-transparent'}`} title={cat.name}>{cat.icon}</button>
                            ))}
                        </div>
                    )}

                    {/* Right Sidebar: Item Editor */}
                    {selectedItemId && (
                        <div className="absolute right-4 top-32 w-80 bg-white rounded-lg shadow-xl p-6 ui-layer animate-fade-in no-print">
                            {(() => {
                                const item = items.find(i => i.id === selectedItemId);
                                if (!item) return null;
                                if (item.type === 'bed') {
                                    return (
                                        <div className="space-y-4">
                                            <div className="flex justify-between items-start">
                                                <div><h3 className="font-bold text-lg text-gray-800">Garden Bed</h3><p className="text-xs text-gray-500">Edit Bed Properties</p></div>
                                                <button onClick={() => setSelectedItemId(null)} className="text-gray-400 hover:text-gray-600">Ã—</button>
                                            </div>
                                            <div>
                                                <label className="block text-xs font-bold text-gray-600 mb-1">SUNLIGHT EXPOSURE</label>
                                                <select className="w-full border p-2 rounded text-sm" value={item.sunlight} onChange={(e) => updateItem(item.id, { sunlight: e.target.value })}>
                                                    <option value="Full Sun">Full Sun (6+ hrs direct)</option>
                                                    <option value="Partial Sun">Partial Sun (4-6 hrs)</option>
                                                    <option value="Mostly Shade">Mostly Shade (&lt;4 hrs)</option>
                                                </select>
                                            </div>
                                            <div className="pt-4 border-t flex justify-between"><button onClick={() => deleteItem(item.id)} className="text-red-500 text-sm hover:underline">Remove Bed</button><button onClick={() => setSelectedItemId(null)} className="bg-blue-600 text-white px-4 py-1 rounded text-sm">Done</button></div>
                                        </div>
                                    );
                                } else {
                                    const category = PLANT_CATEGORIES.find(c => c.id === item.category);
                                    const availablePlants = PLANT_DATABASE[item.category] || [];
                                    return (
                                        <div className="space-y-4">
                                            <div className="flex justify-between items-start">
                                                <div><h3 className="font-bold text-lg text-gray-800">{category.name}</h3><p className="text-xs text-gray-500">Edit Plant Properties</p></div>
                                                <button onClick={() => setSelectedItemId(null)} className="text-gray-400 hover:text-gray-600">Ã—</button>
                                            </div>
                                            <div>
                                                <label className="block text-xs font-bold text-gray-600 mb-1">PLANT VARIETY</label>
                                                <select className="w-full border p-2 rounded text-sm" value={item.confirmed ? item.name : ""} onChange={(e) => updateItem(item.id, { name: e.target.value, confirmed: true })}>
                                                    <option value="" disabled>Select a plant...</option>
                                                    {availablePlants.map(p => (<option key={p.sku} value={p.name}>{p.name}</option>))}
                                                </select>
                                            </div>
                                            <div>
                                                <label className="block text-xs font-bold text-gray-600 mb-1">CONTAINER SIZE</label>
                                                <div className="grid grid-cols-3 gap-2">
                                                    {POT_SIZES.map(size => (<button key={size.label} onClick={() => updateItem(item.id, { sizeLabel: size.label, radius: getRadiusInMeters(size.circumference) })} className={`text-xs py-2 border rounded ${item.sizeLabel === size.label ? 'bg-blue-600 text-white border-blue-600' : 'text-gray-600 hover:bg-gray-50'}`}>{size.label.split(' ')[0]} Gal</button>))}
                                                </div>
                                            </div>
                                            <div className="pt-4 border-t flex justify-between"><button onClick={() => deleteItem(item.id)} className="text-red-500 text-sm hover:underline">Remove Plant</button><button onClick={() => setSelectedItemId(null)} className="bg-blue-600 text-white px-4 py-1 rounded text-sm">Done</button></div>
                                        </div>
                                    );
                                }
                            })()}
                        </div>
                    )}

                    {/* Bottom Right: Shopping List */}
                    {view === 'planning' && wizardStep === 0 && (
                        <div className={`absolute bottom-0 right-4 bg-white rounded-t-lg shadow-[0_-5px_20px_rgba(0,0,0,0.1)] transition-all duration-300 ui-layer w-80 no-print ${showShoppingList ? 'h-96' : 'h-12'}`}>
                            <div className="h-12 bg-blue-900 text-white flex items-center justify-between px-4 rounded-t-lg cursor-pointer hover:bg-blue-800" onClick={() => setShowShoppingList(!showShoppingList)}>
                                <span className="font-bold flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>YOUR SHOPPING LIST ({shoppingList.reduce((a,b) => a + b.count, 0)})</span>
                                <span>{showShoppingList ? 'â–¼' : 'â–²'}</span>
                            </div>
                            {showShoppingList && (
                                <div className="p-4 h-[calc(100%-3rem)] overflow-y-auto">
                                    {shoppingList.length === 0 ? (<div className="text-center text-gray-400 mt-10 text-sm">Start adding plants to build your list.</div>) : (
                                        <div className="space-y-3">
                                            {shoppingList.map((item, idx) => (<div key={idx} className="flex justify-between items-center border-b pb-2"><div><div className="font-bold text-gray-800 text-sm">{item.name}</div><div className="text-xs text-gray-500">{item.size}</div></div><div className="bg-blue-100 text-blue-800 font-bold px-3 py-1 rounded-full text-xs">x{item.count}</div></div>))}
                                            <button className="w-full bg-orange-500 text-white font-bold py-2 rounded mt-4 hover:bg-orange-600 transition">CHECKOUT NOW</button>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    )}
                    
                    {/* Settings Modal for API Key */}
                    <div className="absolute bottom-4 left-4 ui-layer no-print">
                         <button onClick={() => setShowSettings(!showSettings)} className="bg-white p-2 rounded-full shadow-lg text-gray-500 hover:text-gray-800">
                             <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
                         </button>
                         {showSettings && (
                             <div className="absolute bottom-12 left-0 bg-white p-4 rounded-lg shadow-xl w-72">
                                 <h4 className="font-bold text-gray-800 mb-2 text-sm">Settings</h4>
                                 <label className="block text-xs text-gray-600 mb-1">Gemini API Key (Required for Magic Illustration)</label>
                                 <input 
                                    type="password" 
                                    className="w-full border p-2 rounded text-xs mb-2" 
                                    placeholder="Paste API Key here..."
                                    value={userApiKey}
                                    onChange={(e) => setUserApiKey(e.target.value)}
                                />
                                <p className="text-[10px] text-gray-400">Key is used only locally for image generation.</p>
                             </div>
                         )}
                    </div>
                </>
            );

            return (
                <div className="relative w-full h-full">
                    {view === 'landing' ? renderLanding() : (
                        <>
                            <div id="map" ref={mapRef} className={(wizardStep > 0 && wizardStep < 4) || isDrawingBed ? "cursor-crosshair" : ""}></div>
                            {renderMapUI()}
                        </>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
